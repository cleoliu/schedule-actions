name: ã€Renderã€‘every 15m

on:
  schedule:
    - cron: "*/15 * * * *" # æ¯ 15 åˆ†é˜ï¼ˆUTCï¼‰
  workflow_dispatch: {} # å¯æ‰‹å‹•è§¸ç™¼

concurrency:
  group: ping-render # é¿å…é‡ç–ŠåŸ·è¡Œ
  cancel-in-progress: true

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping Render app
        shell: bash
        run: |
          set -Eeuo pipefail

          URL="https://cleo.onrender.com/"
          TS="$(date +%s)"

          # ç‚ºäº†ç©©å®šï¼šå¸¶ä¸Š random jitterï¼Œé™ä½åŒä¸€æ™‚é–“æ’è»Šçš„æ©Ÿç‡
          sleep $(( RANDOM % 5 ))

          echo "Pinging: ${URL}?t=${TS}"

          # å¢åŠ é‡è©¦æ©Ÿåˆ¶ï¼Œå› ç‚º Render å…è²»æœå‹™å¯èƒ½éœ€è¦å†·å•Ÿå‹•
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt ${RETRY_COUNT}/${MAX_RETRIES}..."
            
            # ç¬¬ä¸€æ¬¡å˜—è©¦ç”¨è¼ƒé•·çš„è¶…æ™‚æ™‚é–“ï¼ˆ60ç§’ï¼‰ï¼Œå¾ŒçºŒå˜—è©¦ç”¨ 30 ç§’
            if [ $RETRY_COUNT -eq 1 ]; then
              TIMEOUT=60
            else
              TIMEOUT=30
            fi
            
            # -L è·Ÿéš¨è½‰å€ï¼›-s å®‰éœæ¨¡å¼ï¼›-S é¡¯ç¤ºéŒ¯èª¤ï¼›-f é 2xx/3xx è¦–ç‚ºå¤±æ•—
            http_code=$(curl -LsfS --max-time $TIMEOUT --connect-timeout 30 -o /dev/null -w "%{http_code}" "${URL}?t=${TS}&retry=${RETRY_COUNT}" || echo "000")
            echo "HTTP ${http_code} (timeout: ${TIMEOUT}s)"
            
            if [[ "$http_code" =~ ^2|3 ]]; then
              echo "âœ… Ping successful!"
              SUCCESS=true
            else
              echo "âŒ Ping failed (HTTP ${http_code})"
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "Waiting 10 seconds before retry..."
                sleep 10
              fi
            fi
          done

          # å¦‚æœæ‰€æœ‰é‡è©¦éƒ½å¤±æ•—ï¼Œè®“ job å¤±æ•—
          if [ "$SUCCESS" = false ]; then
            echo "ğŸš¨ All ${MAX_RETRIES} attempts failed. This might indicate:"
            echo "   - Render service is experiencing issues"
            echo "   - Service is taking longer than usual to cold start"
            echo "   - Network connectivity problems"
            exit 1
          fi

      - name: Optional HEAD (quick warm confirm)
        shell: bash
        run: |
          set -Eeuo pipefail
          URL="https://cleo.onrender.com/"
          curl -Is --max-time 10 "${URL}?t=$(date +%s)" | head -n 1 || true
